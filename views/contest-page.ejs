<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Диплом</title>
	<link rel="stylesheet" href="../css/main.css" type="text/css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
	<script src="../socket.io/socket.io.js"></script>
</head>
<body>

	<div class="container">
		<div class="row p-2">
			<div class="col-10">
				Привет <b><%=username %>[<%=idaccount %>]</b>
			</div>
			<div class="col-2">
				<form action="exit" method="POST">
					<button class="btn btn-sm btn-outline-danger" type="submit">Logout</button>
				</form>
			</div>
		</div>
		<div class="row">
			<div class="col-3 bg-dark">
				<ul class="nav nav-pills flex-column">
					<% if(tasks != null) for(var i=0; i<tasks.length; i++) {%>
						<li class="nav-item">
							<a class="nav-link text-light" href="/contest-page/<%=tasks[i].id %>"><%=tasks[i].task_name %></a>
						</li>
					<%} %>
				</ul>
			</div>
			<div class="col-9 bg-light pt-3">
				<p><%=tasks[contestid-1].task_info %></p>

				

				 <!-- Nav bar -->
				 <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Ввести код</a>
                    </li>
                    <li class="nav-item" role="presentation">
                      <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Загрузить файл с кодом</a>
                    </li>
                </ul>
                <!-- Nav bar -->

                <div class="tab-content mb-2" id="myTabContent">

					<select class="custom-select mt-2" id="type">
						<option selected value="1">Nodejs</option>
						<option value="2">Python</option>
						<option value="3">C</option>
						<option value="4">C++</option>
						<option value="5">Java</option>
					</select>

                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                            <label for="codeText">Введите ваш код</label>
                            <textarea class="form-control" id="codeText" rows="3"></textarea>
							<button type="button" class="btn btn-primary mt-2" id="sendCode">Отправить и проверить</button>
                    </div>

                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
						<form id="uploadForm" enctype="multipart/form-data" method="post">
							<input type="hidden" value="<%=tasks[contestid-1].id %>" id="taskId">
							<input type="hidden" value="<%=idaccount %>" id="userId">
							
                            <label for="codeFile">Загрузите файл с исходным кодом</label><br>
                            <input type="file" name="filedata" id="codeFile">
							<button type="button" class="btn btn-primary" id="sendFile">Отправить и проверить</button>
							<span id = "status"></span>
						</form>
					</div>
					
				</div>

				<table class="table" id="resulTable">
					<thead class="thead-dark">
					  <tr>
						<th scope="col">Дата</th>
						<th scope="col">Код</th>
						<th scope="col">Результат</th>
					  </tr>
					</thead>
					<tbody>
					  
						<% if(attempts != null) for(var i=0; i<attempts.length; i++) {%>
							<tr>
								<td><%=attempts[i].date %></td>
								<td><%=attempts[i].code %></td>
								<td><%=attempts[i].result %></td>
							</tr>
						<%} %>
						
					
					</tbody>
				</table>

			</div>

		</div>
	</div>
	
	
	
</body>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
<script>

	$(document).ready(function() {
		

  
		$("#sendFile").click(function(){
			$("#sendFile").append("<span class='spinner-border spinner-border-sm ml-1' role='status' aria-hidden='true'></span>");

			var form = document.getElementById("uploadForm"),
			

			langId = $('#type').val();
			taskId = $('#taskId').val();
			userId = $('#userId').val();

			var formData = new FormData(form);
			formData.append('checkType', 'file');
			formData.append('langId', langId);
			formData.append('task_id', taskId);
			formData.append('user_id', userId);

			var res = new XMLHttpRequest();
			res.open( "post", "/checkfile", true );
			res.send(formData);

			res.onload = function() {
				arr = res.response.split(',')
				addCol(arr[0],arr[1],arr[2]);
				console.log(arr);
				console.log(res.response);
				
			};

			res.onerror = function() { // происходит, только когда запрос совсем не получилось выполнить
			alert(`Ошибка соединения`);
			};

			res.onprogress = function(event) { // запускается периодически
			// event.loaded - количество загруженных байт
			// event.lengthComputable = равно true, если сервер присылает заголовок Content-Length
			// event.total - количество байт всего (только если lengthComputable равно true)
	
			};
	  });    

	  	$("#sendCode").click(function(){
			$("#sendCode").append("<span class='spinner-border spinner-border-sm ml-1' role='status' aria-hidden='true'></span>");



			langId = $('#type').val();
			taskId = $('#taskId').val();
			userId = $('#userId').val();
			codeText = $('#codeText').val();

			var formData = new FormData();
			formData.append('checkType', 'text');
			formData.append('langId', langId);
			formData.append('task_id', taskId);
			formData.append('user_id', userId);
			formData.append('codeText', codeText);
			

			var res = new XMLHttpRequest();
			res.open( "post", "/checktext", true );
			res.send(formData);

			res.onload = function() {
				arr = res.response.split(',')
				addCol(arr[0],arr[1],arr[2]);
				console.log(arr);
				console.log(res.response);
				
			};

			res.onerror = function() { // происходит, только когда запрос совсем не получилось выполнить
			alert(`Ошибка соединения`);
			};

			res.onprogress = function(event) { 
				
			// event.lengthComputable = равно true, если сервер присылает заголовок Content-Length
			// event.total - количество байт всего (только если lengthComputable равно true)
			};
		}); 

		function addCol(date, code, result){
			$("#sendCode").remove();
			$("#sendFile").remove();
			$('#resulTable tr:last').after('<tr><td>'+date+'</td><td>'+code+'</td><td>'+result+'</td></tr>');
		}
  });
  </script>
</html>